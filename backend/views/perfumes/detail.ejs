<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <title><%= perfume.name %></title>
  <link rel="stylesheet" href="/css/style.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <style>
    body {
      background: #0c0c0c;
      color: #fff;
      font-family: 'Poppins', sans-serif;
      margin: 0;
      padding: 0;
      line-height: 1.6;
    }

    .container {
      width: 90%;
      max-width: 1000px;
      margin: 50px auto;
    }

    .detail {
      display: flex;
      gap: 40px;
      grid-template-columns: repeat(4, 1fr);
      flex-wrap: wrap;
      align-items: flex-start;
    }

    .detail img {
      width: 450px;
      border-radius: 10px;
      object-fit: cover;
      border: 1px solid #2a2a2a;
      box-shadow: 0 4px 12px rgba(0,0,0,0.4);
    }

    .info { flex: 1; min-width: 300px; }
    .info h1 { font-size: 26px; margin-bottom: 10px; }

    .price {
      color: #c41e3a;
      font-weight: 600;
      font-size: 22px;
      margin: 15px 0;
    }

    .rating { margin-top: 10px; font-size: 20px; color: #f5c518; }

    /* Comment */
    .comment-section { margin-top: 60px; }
    .comment-section h2 {
      border-left: 4px solid #c41e3a;
      padding-left: 12px;
      margin-bottom: 20px;
      font-size: 20px;
    }

    .comment {
      background: #151515;
      border: 1px solid #222;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 12px;
      position: relative;
    }

    .comment small { color: #aaa; display: block; margin-top: 8px; font-size: 13px; }

    .comment-form textarea,
    .edit-form textarea {
      width: 100%;
      background: #111;
      color: #fff;
      border: 1px solid #333;
      border-radius: 6px;
      padding: 10px;
      resize: none;
      margin-bottom: 10px;
      font-size: 14px;
    }

    .comment-form select, .edit-form select {
      background: #111;
      color: #fff;
      border: 1px solid #333;
      border-radius: 6px;
      padding: 8px;
      margin-bottom: 10px;
    }

    .comment-form button, .edit-form button {
      background: #c41e3a;
      color: #fff;
      border: none;
      padding: 8px 18px;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 500;
      transition: 0.3s;
    }

    .comment-form button:hover, .edit-form button:hover {
      background: #a0142e;
    }

    .comment-actions a {
      color: #c41e3a;
      font-size: 13px;
      margin-right: 10px;
      cursor: pointer;
      text-decoration: none;
    }
    .price {
      font-color: #c41e3a;
    }
    .comment-actions a:hover { text-decoration: underline; }

    .edit-form { display: none; margin-top: 10px; }
  </style>
</head>

<body>
  <%- include('../partials/header') %>

  <div class="container">
    <!-- Chi ti·∫øt n∆∞·ªõc hoa -->
    <div class="detail">
      <img src="<%= perfume.image %>" alt="<%= (perfume.perfumeName || perfume.name) %>" width="1200 px" height="720 px">
      <div class="info">
        <h1><%= (perfume.perfumeName || perfume.name) %></h1>
        <p><b>Brand:</b> <%= (perfume.brand && (perfume.brand.brandName || perfume.brand.name)) || perfume.brand || '‚Äî' %></p>
        <!-- <p><b>URI:</b> <%= perfume.uri || '‚Äî' %></p> -->
        <p><b>Concentration:</b> <%= perfume.concentration || '‚Äî' %></p>
        <p><b>Volume:</b> <%= perfume.volume ? (perfume.volume + ' ml') : '‚Äî' %></p>
        <p><b>Target:</b> <%= perfume.targetAudience || perfume.gender || '‚Äî' %></p>
        <p class="price"><b>Price:</b> <%= perfume.price.toLocaleString() %> VND</p>
        <p><%= perfume.description || "No description for this product." %></p>
        <% if (perfume.ingredients) { %>
          <p><b>Ingredients:</b> <%= perfume.ingredients %></p>
        <% } %>

      </div>
    </div>

    <div class="rating">
      <% if (typeof ratingsCount !== 'undefined' && ratingsCount > 0) { %>
        ‚≠ê Rating: <%= avgRating.toFixed(1) %>/3 (from <%= ratingsCount %> reviews)
      <% } else { %>
        ‚≠ê Rating: Not Yet
      <% } %>
    </div>

    <!-- B√¨nh lu·∫≠n -->
<div class="comment-section" id="comments">
  <h2>Comments</h2>

  <% if (member && member.role !== 'admin') { %>
    <% if (!hasCommented) { %>
      <form class="comment-form" action="/perfumes/<%= perfume._id %>/comment" method="POST">
        <label>Rating (1‚Äì3 ‚≠ê):</label>
        <select name="rating" required>
          <option value="1">‚≠ê 1</option>
          <option value="2">‚≠ê‚≠ê 2</option>
          <option value="3">‚≠ê‚≠ê‚≠ê 3</option>
        </select>
        <textarea name="content" rows="3" placeholder="Write a comment..." required></textarea>
        <button type="submit">G·ª≠i</button>
      </form>
    <% } else { %>
      <p style="color:#aaa;">‚úÖ B·∫°n ƒë√£ comment s·∫£n ph·∫©m n√†y. B·∫°n c√≥ th·ªÉ s·ª≠a ho·∫∑c x√≥a b√¨nh lu·∫≠n c·ªßa m√¨nh b√™n d∆∞·ªõi.</p>
    <% } %>
  <% } else if (!member) { %>
    <p><a href="/login?redirect=/perfumes/<%= perfume._id %>#comments" class="login-link">Login</a> ƒë·ªÉ b√¨nh lu·∫≠n.</p>
  <% } %>

  <% if (comments && comments.length > 0) { %>
    <% comments.forEach(c => { %>
      <div class="comment" id="comment-<%= c._id %>">
        <p><%= c.content %></p>
        <p>Rating: <%= c.rating %> ‚≠ê</p>
        <small>üë§ <%= c.userId.name %> |<%= c.userId.email %>  | üïí <%= new Date(c.createdAt).toLocaleString() %></small>

        <% if (member && (member._id.toString() === c.userId._id.toString() || member.role === 'admin')) { %>
          <div class="comment-actions">
            <a href="/comments/delete/<%= c._id %>" onclick="return confirm('Delete this comment?')">üóë Delete</a>
            <% if (member.role !== 'admin') { %>
              <a class="edit-link" data-id="<%= c._id %>">‚úèÔ∏è S·ª≠a</a>
            <% } %>
          </div>

          <% if (member.role !== 'admin') { %>
            <form action="/comments/edit/<%= c._id %>" method="POST" class="edit-form" id="edit-form-<%= c._id %>">
              <textarea name="content" rows="2"><%= c.content %></textarea>
              <label>ƒê√°nh gi√°:</label>
              <select name="rating">
                <option value="1" <%= c.rating === 1 ? 'selected' : '' %>>‚≠ê 1</option>
                <option value="2" <%= c.rating === 2 ? 'selected' : '' %>>‚≠ê‚≠ê 2</option>
                <option value="3" <%= c.rating === 3 ? 'selected' : '' %>>‚≠ê‚≠ê‚≠ê 3</option>
              </select>
              <button type="submit">üíæ Update</button>
            </form>
          <% } %>
        <% } %>
      </div>
    <% }) %>
  <% } else { %>
    <p>No comments yet.</p>
  <% } %>
</div>

  </div>

  <%- include('../partials/footer') %>

  <script>

    // B·∫≠t/t·∫Øt form s·ª≠a
    document.querySelectorAll('.edit-link').forEach(btn => {
      btn.addEventListener('click', function () {
        const id = this.dataset.id;
        const form = document.getElementById(`edit-form-${id}`);
        if (form.style.display === 'block') {
          form.style.display = 'none';
        } else {
          form.style.display = 'block';
        }
      });
    });
  </script>
</body>
</html>
